<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Game page</title>

  <!-- THEME VARIABLES -->
  <style>
    :root {
      --bg-main: aliceblue;
      --bg-side: #aaa;
      --bg-grid: rgb(71, 71, 71);
      --text-color: black;
      --border-color: black;
      --accent: blueviolet;
    }

    /* DARK THEME VARIANT */
    body.dark {
      --bg-main: #1e1e1e;
      --bg-side: #2c2c2c;
      --bg-grid: #3a3a3a;
      --text-color: #e0e0e0;
      --border-color: #444;
      --accent: #7a5af5;
    }

    html {
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
      background-color: var(--bg-main);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .row {
      display: flex;
      margin: 0;
      width: 100%;
      height: 100%;
    }

    .column {
      margin: 0;
    }

    .side {
      width: 50%;
      margin: 0;
    }

    .full-screen-div {
      height: 100vh;
      width: 100vw;
      background-color: var(--accent);
    }

    .grid-div {
      width: 60%;
      height: 60%;
      border-color: var(--border-color);
      border-width: 1px;
      border-style: solid;
      background-color: var(--bg-grid);
      margin-left: auto;
      margin-right: auto;
      margin-top: 5%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .grid-row {
      width: 100%;
      height: 20%;
      flex-direction: row;
      display: flex;
    }

    .grid-cell {
      width: 20%;
      height: 100%;
      margin: 0%;
      border-color: var(--border-color);
      border-width: 1px;
      border-style: solid;
      display: flex;
    }

    .grid-cell.pointer {
      outline: 3px solid limegreen;
      background-color: chartreuse;
    }

    .moveindic {
      border: 1px solid var(--border-color);
      height: 130px;
      width: 130px;
      margin: 10px;
    }

    text {
      display: block;
      text-align: center;
      font-weight: 300;
    }

    .game_obj {
      position: absolute;
      width: 20%;
      height: 20%;
      z-index: 10;
      left: 0%;
      top: 0%;
    }

    .belowgrid {
      margin: 5%;
      display: flex;
      border: 1px solid var(--border-color);
    }

    .belowleft {
      width: 70%;
      margin: auto;
    }

    .belowright {
      width: 30%;
      margin: 0;
    }

    .turn-timer {
      width: 60%;
      height: 12px;
      margin: 12px auto 0;
      background: #2e2e2e;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, .4);
    }

    .turn-timer-bar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
    }

    .playerbox {
      height: 20%;
      margin: 20px;
      border: 5px solid var(--border-color);
    }

    .playercount {
      height: 40%;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .playerindiv {
      height: 60%;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .chatbox {
      height: 50%;
      margin: 20px;
      border: 5px solid var(--border-color);
    }

    .chatlist{
      height:80%;
      margin:0
    }

    .chatinput{
      height:20%;
    }

    /* ==== CHAT INPUT BAR ==== */
      #gameform {
        background: var(--input-bg);
        padding: 0.25rem;
        bottom: 0; left: 0; right: 0;
        display: flex; height: 3rem;
        box-sizing: border-box;
        backdrop-filter: blur(10px);
        border-top:2px solid var(--border-color);
        padding: auto;
      }
      #gameinput {
        border: none; padding: 0 1rem; flex-grow: 1;
        border-radius: 2rem; margin: 0.25rem;
        background: var(--card-bg); color: var(--text-color);
      }
      #input:focus { outline: none; }
      #gameform > button {
        background: var(--accent);
        border: none;
        padding: 0 1rem; margin: 0.25rem;
        border-radius: 3px; outline: none; color: #fff;
      }

      #gamemessages { list-style-type: none; margin: 0; padding: 0; }
      #gamemessages > li { padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
      #gamemessages > li:nth-child(odd) { background: rgba(0,0,0,0.03); }

      .button {
        background-color: var(--accent);
        color: white; width: 100%;
        border-radius: 8px; border: none;
        padding: 10px; margin-top: 10px;
        font-size: 16px; cursor: pointer;
      }


    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      padding-top: 100px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: var(--bg-main);
      margin: auto;
      padding: 20px;
      border: 1px solid var(--border-color);
      width: 80%;
      color: var(--text-color);
    }

    #play-again-button:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="row">
    <div class="column side" style="background-color: var(--bg-main)">
      <div class="grid-div" id="main grid">
        <audio id="BGaudio" autoplay loop><source src="assets/monkey.mp3" type="audio/mpeg"></audio>
        <audio id="WinAudio"><source src="assets/cheer.mp3" type="audio/mpeg"></audio>
        <audio id="WalkAudio"><source src="assets/Bwomp.mp3" type="audio/mpeg"></audio>

        <img src="../assets/warder_icon.png" alt="warder" id="warder" class="game_obj">
        <img src="../assets/prisoner_icon.png" alt="prisoner" id="prisoner" class="game_obj">
        <img src="../assets/tunnel_icon.png" alt="tunnel" id="tunnel" class="game_obj">

        <!-- grid -->
        <div class="grid-row" id="row 0">
          <div class="grid-cell" id="cell 0"></div>
          <div class="grid-cell" id="cell 1"></div>
          <div class="grid-cell" id="cell 2"></div>
          <div class="grid-cell" id="cell 3"></div>
          <div class="grid-cell" id="cell 4"></div>
        </div>
        <div class="grid-row" id="row 1">
          <div class="grid-cell" id="cell 5"></div>
          <div class="grid-cell" id="cell 6"></div>
          <div class="grid-cell" id="cell 7"></div>
          <div class="grid-cell" id="cell 8"></div>
          <div class="grid-cell" id="cell 9"></div>
        </div>
        <div class="grid-row" id="row 2">
          <div class="grid-cell" id="cell 10"></div>
          <div class="grid-cell" id="cell 11"></div>
          <div class="grid-cell" id="cell 12"></div>
          <div class="grid-cell" id="cell 13"></div>
          <div class="grid-cell" id="cell 14"></div>
        </div>
        <div class="grid-row" id="row 3">
          <div class="grid-cell" id="cell 15"></div>
          <div class="grid-cell" id="cell 16"></div>
          <div class="grid-cell" id="cell 17"></div>
          <div class="grid-cell" id="cell 18"></div>
          <div class="grid-cell" id="cell 19"></div>
        </div>
        <div class="grid-row" id="row 4">
          <div class="grid-cell" id="cell 20"></div>
          <div class="grid-cell" id="cell 21"></div>
          <div class="grid-cell" id="cell 22"></div>
          <div class="grid-cell" id="cell 23"></div>
          <div class="grid-cell" id="cell 24"></div>
        </div>
      </div>

      <div class="belowgrid">
        <div class="belowleft">
          <text id="countdown" style="text-align: center;">Welcome!</text>
          <text id="movement" style="text-align: center;">Staying</text>
          <div class="turn-timer">
            <div class="turn-timer-bar" id="turnBar"></div>
          </div>
          <text id="player character" style="text-align: center;">Waiting for another player.</text>
        </div>
        <div class="belowright">
          <img src="../assets/arrow/idlew.png" id="moveindic" class="moveindic">
        </div>
      </div>
    </div>

    <div class="column side" style="background-color: var(--bg-side)">
      <div class="playerbox">
        <div class="playercount">Players online: <span id="playerOnline">0</span></div>
        <div class="row">
          <div class="column side playerindiv" id="player1-box"></div>
          <div class="column side playerindiv" id="player2-box"></div>
        </div>
      </div>
      <div class="chatbox">
        <div class="chatlist"><ul id="gamemessages"></ul></div>
        <div class="chatinput">
          <form id="gameform" action="">
        <input id="gameinput" autocomplete="off" /><button>Send</button>
      </form>
    </div>
      </div>
      <!-- game counter -->
<div class="game-counter">
    <div>Game: <span id="current-game">0</span></div>
    <div>Turn: <span id="current-turn">0</span></div>
</div>

    </div>
  </div>

  <!-- The Modal -->
  <div id="ending-modal" class="modal">
    <div class="modal-content">
      <p id="modal-head-text"></p>
      <button id="play-again-button">Yes</button>
      <button id="go-home-button">No</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <script type="module">
    // âœ… Load Theme Preference
    var turnTime = 10
    const savedTheme = localStorage.getItem("theme") || "light";
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
    }
  import { gridInit, display_grid } from '../util/algotest.js';

  function _initObjectPosition(htmlElem, posInGrid) {
    let elemStyle = window.getComputedStyle(htmlElem);
    //console.log(`Initiating position for ${elemStyle}...`);

    // row positioning
    let topVal = elemStyle.getPropertyValue("top").replace("px", "");
    htmlElem.style.top = (Number(topVal) + (Math.floor(posInGrid / 5) * 20)) + "%";

    // column positioning
    let leftVal = elemStyle.getPropertyValue("left").replace("px", "");
    htmlElem.style.left = (Number(leftVal) + ((posInGrid % 5) * 20)) + "%";
    //console.log(`Completed! ${htmlElem.style.top},${htmlElem.style.left}`);
  }

  function gameStart(grid, obsPos, warderPos, prisonerPos, tunnelPos) {
    if (!grid && !obsPos && !warderPos && !prisonerPos && !tunnelPos) {
      // supposed to receive grid from server
      console.log("Error: No grid data from server");
      return;
    }
    //console.log(`Hello, is this ${result}`);
    display_grid(grid);

    let obsPosArray;
    if (obsPos instanceof Set) {
      obsPosArray = Array.from(obsPos);
    }
    else {
      obsPosArray = obsPos
    }

    // put objects to their starting position
    for (let i = 0; i < obsPosArray.length; i++) {
      let pos = obsPosArray[i];
      document.getElementById("main grid").innerHTML += `
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle${i}" class="game_obj">`
      let obs = document.getElementById(`obstacle${i}`);
      _initObjectPosition(obs, pos);
    }

    let prisoner = document.getElementById("prisoner");
    _initObjectPosition(prisoner, prisonerPos);

    let warder = document.getElementById("warder");
    _initObjectPosition(warder, warderPos);

    let tunnel = document.getElementById("tunnel");
    _initObjectPosition(tunnel, tunnelPos);
    tunnel.style.zIndex = 9;
  }

  function moveCharacter(elemId, dx, dy) {
    const elem = document.getElementById(elemId);
    const top = parseFloat(elem.style.top);
    const left = parseFloat(elem.style.left);
    console.log(elem);

    const STEP = 20;
    const COLS = 5;
    const ROWS = 5;

    let row = Math.round(top / STEP);
    let col = Math.round(left / STEP);

    const newRow = row - dy;
    const newCol = col + dx;

    if (newRow < 0 || newRow >= ROWS || newCol < 0 || newCol >= COLS) return false;

    const targetCell = newRow * COLS + newCol;

    const obstaclePositions = [];
    for (let i = 0; i < 5; i++) {
      const obs = document.getElementById(`obstacle${i}`);
      if (!obs) continue;
      const ot = parseFloat(obs.style.top) || 0;
      const ol = parseFloat(obs.style.left) || 0;
      const orow = Math.round(ot / STEP);
      const ocol = Math.round(ol / STEP);
      obstaclePositions.push(orow * COLS + ocol);
    }

    //preventing warder from taking tunnel
    //Broken, fix this
    const tun = document.getElementById("tunnel");
    if (tun){
      const tunOT = parseFloat(tun.style.top) || 0;
      const tunOL = parseFloat(tun.style.left) || 0;
      const tunRow = Math.round(tunOT / STEP);
      const tunCol = Math.round(tunOL / STEP);
      const tunnelPositions = (tunRow * COLS + tunCol);
      if (tunnelPositions == targetCell && elemId=="warder")return false;};
    if (obstaclePositions.includes(targetCell)) return false;
    
    console.log(elem.style.top);
    elem.style.top = `${newRow * STEP}%`;
    elem.style.left = `${newCol * STEP}%`;
    console.log(elem.style.top);
    return true;
  }

  let keyEventHandler; // required for removeEventListener()
  function enableMoveSelection(enable, character) {
    if (enable) {
      // Remove any existing listener first
      if (keyEventHandler) {
        document.removeEventListener("keydown", keyEventHandler);
      }
      keyEventHandler = (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)){
          e.preventDefault();
          if (e.repeat) return;
          const keydict = {
            ArrowUp: "../assets/arrow/up.png", 
            ArrowDown: "../assets/arrow/down.png", 
            ArrowLeft: "../assets/arrow/left.png", 
            ArrowRight: "../assets/arrow/right.png",
            " ": "../assets/arrow/idlew.png"
          }[e.key];
          const worddict = {
            ArrowUp: "Up", 
            ArrowDown: "Down", 
            ArrowLeft: "Left", 
            ArrowRight: "Right",
            " ": "Staying"
          }[e.key];

          const dir = {
            ArrowUp: {dx:0,dy:1}, ArrowDown: {dx:0,dy:-1}, ArrowLeft: {dx:-1,dy:0}, ArrowRight: {dx:1,dy:0}, " ":{dx:0,dy:0}
          }[e.key];
          document.getElementById("movement").textContent = "Your move : " + worddict
          document.getElementById("moveindic").src = keydict
          socket.emit(`${character} select move`, dir);
        }
      };
      document.addEventListener("keydown", keyEventHandler);
    }
    else {
      document.removeEventListener("keydown", keyEventHandler);
      keyEventHandler = null;
    }
  }

  function startCountdown(turnTime) {
    const bar = document.getElementById("turnBar");
    if (!bar) return;
    console.log(turnTime)
    const total = turnTime
    var timeleft = turnTime;

    var timer = setInterval(function(){
      if(timeleft <= 0){
        clearInterval(timer);
      }
      const percent = (timeleft/total) * 100;
      document.getElementById("countdown").textContent = timeleft;
      bar.style.width = percent+"%"
      timeleft -= 1;
    }, 1000);
  }

  async function getUserInfo() {
    const res = await fetch('/api/getUser', {
      method: "GET",
      credentials: "include",
      headers: {
        "Content-Type": "application/json"
      }
    });

    if (res.ok) {
      return await res.json();
    }
  }


  // upon landing, fetch user info
  await getUserInfo();

  // custom "namespace" to split logic of game IO from other IO
  const socket = io("/game");
  var time = 10

  // player count identifier
  socket.on("server:updateOnline", ({ online }) => {
    const el = document.getElementById("playerOnline");
    if (el) el.textContent = online;
  });

  socket.on("Speed", ({time}) => {
    console.log("speed received")
    turnTime = time;
  });

  // "connect" is a built-in event in socket.io. It's auto called every time browser's socket connects successfully
  socket.on("connect", () => {
    console.log("Connected to game namespace");
  });

  socket.on("server:updateGameSpeed", ({ speed }) => {
    console.log('[game client] received server:updateGameSpeed ->', speed);
    time = speed;
  });


  socket.on('server:updateGames', function(data) {
    document.getElementById('current-game').textContent = data.totalGamesPlayed;
  });

  socket.on('server:updateTurns', function(data) {
    document.getElementById('current-turn').textContent = data.totalTurnsThisGame;
  });

  socket.on("first player", (player) => {
    document.getElementById("player1-box").innerHTML += `
      <text>Player: ${player.userName}</text>
      <text>Win count: ${player.win}</text>
      <text>Lose count: ${player.lose}</text>`;
  });

  socket.on("both players", (players) => {
    const [p1, p2] = players;
    document.getElementById("player1-box").innerHTML = `
      <text>${p1.userName}</text>
      <text>win count: ${p1.win}</text>
      <text>lose count: ${p1.lose}</text>`;

    document.getElementById("player2-box").innerHTML = `
      <text>${p2.userName}</text>
      <text>win count: ${p2.win}</text>
      <text>lose count: ${p2.lose}</text>`;
  });

  // custom event, must be emitted by server to be activated
  socket.on("start game", (data) => {
    gameStart(data.grid, data.obsPosArray, data.warderPos, data.prisonerPos, data.tunnelPos, data.character);
    document.getElementById("player character").textContent = `You are ${data.character}`
  });

  socket.on("turn start", ({character, time2}) => {
    console.log("turn start reached");
    enableMoveSelection(true, character);
    startCountdown(time2);
  });

  socket.on("turn end", (data) => {
    console.log(`${data.character}'s turn has ended.`);
    console.log(data);
    enableMoveSelection(false, data.character);
    document.getElementById("movement").textContent = "Your move : "
    if (data.dx !== null && data.dy !== null) {
      if(moveCharacter(data.character, data.dx, data.dy)){
        socket.emit("move", data.dx, data.dy)
      }
      else{
        socket.emit("move", 0,0)
      }
    }
    document.getElementById('WalkAudio').play()
    document.getElementById("moveindic").src = "../assets/arrow/idlew.png"
  })



  // stuff for when game ends (play again or exit)
  var modal = document.getElementById("ending-modal");

  socket.on("game over", (winner) =>{
    document.getElementById("modal-head-text").innerText = `${winner} won. Do both players want to play again?`;
    modal.style.display = "block";
    document.getElementById('WinAudio').play()

    var playBtn = document.getElementById("play-again-button");
    playBtn.disabled = false;
    var exitBtn = document.getElementById("go-home-button");

    playBtn.addEventListener("click", () => {
      socket.emit("play again selected");
      playBtn.disabled = true;
      playBtn.removeEventListener();
    });

    exitBtn.addEventListener("click", () => {
      socket.emit("exit selected");
      exitBtn.removeEventListener();
    });
  });

  socket.on("exit", () => {
    modal.style.display = "none";
    window.location.href = "/";
  });

  socket.on("play again", () => {
    modal.style.display = "none";
    window.location.reload();
  });



  socket.on("reset:all", () => {
    console.log("Server requested full reset");
    alert("Game has been reset by admin!");
    window.location.href = "/"; // go back to home page
  });
  
  // Chat box part
  const form = document.getElementById('gameform');
  const input = document.getElementById('gameinput');
  const messages = document.getElementById('gamemessages');

  form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit('chat message', input.value);
          input.value = '';
        }
      });

  socket.on('chat message', (msg) => {
        const item = document.createElement('li');
        console.log("message is "+ msg)
        item.textContent = msg;
        messages.appendChild(item);
        if(messages.getElementsByTagName("li").length==9){
          messages.firstChild.remove()
        }

        // window.scrollTo(0, document.body.scrollHeight);
      });
</script>

</html>