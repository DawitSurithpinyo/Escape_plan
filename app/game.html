<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Game page</title>
</head>
<style>
  html {
    height: 100%;
  }

  body {
    margin: 0;
    height: 100%
  }

  .row {
    display: flex;
    margin: 0;
    width: 100%;
    height: 100%
  }

  .column {
    margin: 0
  }

  .side {
    width: 25%;
    margin: 0
  }

  .middle {
    width: 50%;
    margin: 0
  }

  .full-screen-div {
    height: 100vh;
    width: 100vw;
    background-color: blueviolet;
  }

  .grid-div {
    width: 60%;
    height: 60%;
    border-color: black;
    border-width: 1px;
    border-style: solid;
    background-color: rgb(71, 71, 71);
    margin-left: auto;
    /* auto margin-left = push to right */
    margin-right: auto;
    /* auto both margins = centered */
    margin-top: 5%;
    display: flex;
    /* prevent child div overflowing */
    flex-direction: column;
    position: relative;
  }

  .grid-row {
    width: 100%;
    height: 20%;
    flex-direction: row;
    display: flex;
  }

  .grid-cell {
    width: 20%;
    height: 100%;
    margin: 0%;
    border-color: black;
    border-width: 1px;
    border-style: solid;
    display: flex;
  }

  .grid-cell.pointer {
    outline: 3px solid limegreen;
    background-color: chartreuse;
  }
  text{
    display: block;
    text-align: center;
    font-weight: 300;
  }

  .game_obj {
    /* images of warder, prisoner, obstacles, tunnel, etc. */
    /* position: absolute;
      margin-top: -100px;
      margin-left: -100px;
        */
    position: absolute;
    width: 20%;
    height: 20%;
    /* align-self: center; */
    z-index: 10;
    /* margin: auto; */
    /* top: 100px; */
    left: 0%;
    top: 0%;
    /* transform: translate(-50%); */
    /* left: 100%; */
    /* bottom: 20px; */
  }
  .turn-timer {
  width: 60%;
  height: 12px;
  margin: 12px auto 0;
  background: #2e2e2e;
  border-radius: 999px;
  overflow: hidden;
  box-shadow: inset 0 0 4px rgba(0, 0, 0, .4);
}

.turn-timer-bar {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #4ade80, #22c55e);
}

</style>

<body>
  <div class="row">
    <div class="column side" style="background-color: aqua;">This is to the left</div>
    <div class="column middle" style="background-color: aliceblue">
      <div class="grid-div" id="main grid">
        <img src="../assets/warder_icon.png" alt="warder" id="warder" class="game_obj">
        <img src="../assets/prisoner_icon.png" alt="prisoner" id="prisoner" class="game_obj">
        <img src="../assets/tunnel_icon.png" alt="tunnel" id="tunnel" class="game_obj">
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle0" class="game_obj">
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle1" class="game_obj">
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle2" class="game_obj">
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle3" class="game_obj">
        <img src="../assets/obstacle_icon.png" alt="obstacle" id="obstacle4" class="game_obj">

        <div class="grid-row" id="row 0">
          <div class="grid-cell" id="cell 0"></div>
          <div class="grid-cell" id="cell 1"></div>
          <div class="grid-cell" id="cell 2"></div>
          <div class="grid-cell" id="cell 3"></div>
          <div class="grid-cell" id="cell 4"></div>
        </div>
        <div class="grid-row" id="row 1">
          <div class="grid-cell" id="cell 5"></div>
          <div class="grid-cell" id="cell 6"></div>
          <div class="grid-cell" id="cell 7"></div>
          <div class="grid-cell" id="cell 8"></div>
          <div class="grid-cell" id="cell 9"></div>
        </div>
        <div class="grid-row" id="row 2">
          <div class="grid-cell" id="cell 10"></div>
          <div class="grid-cell" id="cell 11"></div>
          <div class="grid-cell" id="cell 12"></div>
          <div class="grid-cell" id="cell 13"></div>
          <div class="grid-cell" id="cell 14"></div>
        </div>
        <div class="grid-row" id="row 3">
          <div class="grid-cell" id="cell 15"></div>
          <div class="grid-cell" id="cell 16"></div>
          <div class="grid-cell" id="cell 17"></div>
          <div class="grid-cell" id="cell 18"></div>
          <div class="grid-cell" id="cell 19"></div>
        </div>
        <div class="grid-row" id="row 4">
          <div class="grid-cell" id="cell 20"></div>
          <div class="grid-cell" id="cell 21"></div>
          <div class="grid-cell" id="cell 22"></div>
          <div class="grid-cell" id="cell 23"></div>
          <div class="grid-cell" id="cell 24"></div>
        </div>
      </div>
      <text id="countdown" style="text-align: center;">Welcome!</text>
      <text id="movement" style="text-align: center;">Staying</text>
      <div class="turn-timer">
        <div class="turn-timer-bar" id="turnBar"></div>
      </div>
      <text id="player character" style="text-align: center;">Waiting for another player.</text>
    </div>
    <div class="column side" style="background-color: salmon">This is to the right</div>
    <p>Players online: <span id="playerOnline">0</span></p>
  </div>
  <!-- <div class="full-screen-div">The watcher</div> -->
</body>

<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import { gridInit, display_grid } from '../util/algotest.js';

  function _initObjectPosition(htmlElem, posInGrid) {
    let elemStyle = window.getComputedStyle(htmlElem);
    //console.log(`Initiating position for ${elemStyle}...`);

    // row positioning
    let topVal = elemStyle.getPropertyValue("top").replace("px", "");
    htmlElem.style.top = (Number(topVal) + (Math.floor(posInGrid / 5) * 20)) + "%";

    // column positioning
    let leftVal = elemStyle.getPropertyValue("left").replace("px", "");
    htmlElem.style.left = (Number(leftVal) + ((posInGrid % 5) * 20)) + "%";
    //console.log(`Completed! ${htmlElem.style.top},${htmlElem.style.left}`);
  }

  function gameStart(grid, obsPos, warderPos, prisonerPos, tunnelPos) {
    if (!grid && !obsPos && !warderPos && !prisonerPos && !tunnelPos) {
      // generate random map
      const result = gridInit();
      grid = result.grid;
      obsPos = result.obsPos;
      warderPos = result.warderPos;
      prisonerPos = result.prisonerPos;
      tunnelPos = result.tunnelPos;
      
    }
    //console.log(`Hello, is this ${result}`);
    display_grid(grid);

    let obsPosArray;
    if (obsPos instanceof Set) {
      obsPosArray = Array.from(obsPos);
    }
    else {
      obsPosArray = obsPos
    }

    // put objects to their starting position
    for (let i = 0; i < obsPosArray.length; i++) {
      let pos = obsPosArray[i];
      let obs = document.getElementById(`obstacle${i}`);
      _initObjectPosition(obs, pos);
    }

    let prisoner = document.getElementById("prisoner");
    _initObjectPosition(prisoner, prisonerPos);

    let warder = document.getElementById("warder");
    _initObjectPosition(warder, warderPos);

    let tunnel = document.getElementById("tunnel");
    _initObjectPosition(tunnel, tunnelPos);
    tunnel.style.zIndex = 9;


    // // actually start game
    // let winner;
    // while(!winner) {
    //   var timeleft = 10;
    //   var downloadTimer = setInterval(function(){
    //     if(timeleft <= 0){
    //       clearInterval(downloadTimer);
    //     }
    //     document.getElementById("countdown").textContent = timeleft;
    //     timeleft -= 1;
    //   }, 1000);

    //   let timeout = setTimeout()
    // }
  }

  function moveCharacter(elemId, dx, dy) {
    const elem = document.getElementById(elemId);
    const top = parseFloat(elem.style.top);
    const left = parseFloat(elem.style.left);
    console.log(elem);

    const STEP = 20;
    const COLS = 5;
    const ROWS = 5;

    let row = Math.round(top / STEP);
    let col = Math.round(left / STEP);

    const newRow = row - dy;
    const newCol = col + dx;

    if (newRow < 0 || newRow >= ROWS || newCol < 0 || newCol >= COLS) return false;

    const targetCell = newRow * COLS + newCol;

    const obstaclePositions = [];
    for (let i = 0; i < 5; i++) {
      const obs = document.getElementById(`obstacle${i}`);
      if (!obs) continue;
      const ot = parseFloat(obs.style.top) || 0;
      const ol = parseFloat(obs.style.left) || 0;
      const orow = Math.round(ot / STEP);
      const ocol = Math.round(ol / STEP);
      obstaclePositions.push(orow * COLS + ocol);
    }

    //preventing warder from taking tunnel
    //Broken, fix this
    const tun = document.getElementById("tunnel");
    if (tun){
      const tunOT = parseFloat(tun.style.top) || 0;
      const tunOL = parseFloat(tun.style.left) || 0;
      const tunRow = Math.round(tunOT / STEP);
      const tunCol = Math.round(tunOL / STEP);
      const tunnelPositions = (tunRow * COLS + tunCol);
      if (tunnelPositions == targetCell && elemID=="warder")return false;};
    if (obstaclePositions.includes(targetCell)) return false;
    
    console.log(elem.style.top);
    elem.style.top = `${newRow * STEP}%`;
    elem.style.left = `${newCol * STEP}%`;
    console.log(elem.style.top);
    return true;
  }

  let keyEventHandler; // required for removeEventListener()
  function enableMoveSelection(enable, character) {
    if (enable) {
      // Remove any existing listener first
      if (keyEventHandler) {
        document.removeEventListener("keydown", keyEventHandler);
      }

      keyEventHandler = (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
          e.preventDefault();
          if (e.repeat) return;

          const dir = {
            ArrowUp: {dx:0,dy:1}, ArrowDown: {dx:0,dy:-1}, ArrowLeft: {dx:-1,dy:0}, ArrowRight: {dx:1,dy:0}
          }[e.key];
          document.getElementById("movement").textContent = "you pressed " + e.key
          socket.emit(`${character} select move`, dir);
        }
      };
      document.addEventListener("keydown", keyEventHandler);
    }
    else {
      document.removeEventListener("keydown", keyEventHandler);
      keyEventHandler = null;
    }
  }

  function startCountdown() {
    const bar = document.getElementById("turnBar");
    if (!bar) return;


    var timeleft = 10;
    var total = timeleft;

    var timer = setInterval(function(){
      if(timeleft <= 0){
        clearInterval(timer);
      }
      const percent = (timeleft/total) * 100;
      document.getElementById("countdown").textContent = timeleft;
      bar.style.width = percent+"%"
      timeleft -= 1;
    }, 1000);
  }


  // custom "namespace" to split logic of game IO from other IO
  const socket = io("/game");

  // player count identifier
  socket.on("server:updateOnline", ({ online }) => {
    const el = document.getElementById("playerOnline");
    if (el) el.textContent = online;
  });

  // "connect" is a built-in event in socket.io. It's auto called every time browser's socket connects successfully
  socket.on("connect", () => {
    console.log("Connected to game namespace");
  });

  // custom event, must be emitted by server to be activated
  socket.on("start game", (data) => {
    gameStart(data.grid, data.obsPosArray, data.warderPos, data.prisonerPos, data.tunnelPos, data.character);
    document.getElementById("player character").textContent = `You are ${data.character}`
  });

  socket.on("turn start", (character) => {
    console.log("turn start reached");
    enableMoveSelection(true, character);
    startCountdown();
  });

  socket.on("turn end", (data) => {
    console.log(`${data.character}'s turn has ended.`);
    console.log(data);
    enableMoveSelection(false, data.character);
    if (data.dx !== null && data.dy !== null) {
      if(moveCharacter(data.character, data.dx, data.dy)){
        socket.emit("move", data.dx, data.dy)
      }
      else{
        socket.emit("move", 0,0)
      }
    }
  })

  socket.on("game over", (winner) =>{
    window.alert(`${winner} win`);
    console.log(`${winner} win`);
  });
</script>

</html>